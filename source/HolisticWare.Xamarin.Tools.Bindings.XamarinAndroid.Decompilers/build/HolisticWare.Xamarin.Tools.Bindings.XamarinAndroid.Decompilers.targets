<!--
  NuGet automatically imports this file into any project that has a PackageReference to 'SampleTasks'.
  To see this in action, execute "dotnet restore" on the 3-NuGet example and look in the obj/ folder for
  a file named Web.csproj.g.nuget.targets. You'll see inside that it contains an "Import" to this file.
 -->
<Project>

    <PropertyGroup>  
        <!--
        <EnableDefaultItems>false</EnableDefaultItems>
        -->
        <BindingsHelperFolder>holisticware-generated</BindingsHelperFolder>  
        <BindingsHelperFolderInProject>$(MSBuildProjectDirectory)/$(BindingsHelperFolder)</BindingsHelperFolderInProject>  
        
        <BindingsHelperFolderDecompilerOutput>$(BindingsHelperFolderInProject)/decompilers</BindingsHelperFolderDecompilerOutput>  
        <BindingsHelperFolderLibs>$(BindingsHelperFolderInProject)/lib/</BindingsHelperFolderLibs>  
        <BindingsHelperFolderLibsInNuget>$(MSBuildThisFileDirectory)../lib/</BindingsHelperFolderLibsInNuget>
        
    </PropertyGroup>  
    
    <Target 
        Name="BindingsHelpersClean" 
        BeforeTargets="Build;Clean"
        >  
        <Message Text="mc++ AfterTargets=Clean" />  
        <!--
        <RemoveDir Directories="$(BindingsHelperFolder)" />  
        -->
    </Target>
    
    <Target 
        Name="BindingsHelpersInit" 
        BeforeTargets="CoreCompile"
        >  
        <MakeDir Directories="$(BindingsHelperFolder)" />  
        <MakeDir Directories="$(BindingsHelperFolderLibs)" />  
        <MakeDir Directories="$(BindingsHelperFolderDecompilerOutput)" />  
        
        <Exec Command="pwd"></Exec>
        <Exec Command="ls -al $(BindingsHelperFolder)"></Exec>
        <Exec Command="ls -al $(BindingsHelperFolderLibs)"></Exec>
        <Exec Command="ls -al $(BindingsHelperFolderDecompilerOutput)"></Exec>
        <Exec Command="ls -al $(BindingsHelperFolderLibsInNuget)"></Exec>
    </Target>
    
    <ItemGroup>
        <Folder Include="$(BindingsHelperFolder)/" />
        <Folder Include="$(BindingsHelperFolderLibs)/" />
        <Folder Include="$(BindingsHelperFolderDecompilerOutput)/" />
        
        <!--
        https://github.com/netonjm/GtkSharp.NuGet/pull/1/files
        -->
        <None 
            Include="$(MSBuildThisFileDirectory)/../lib/procyon-decompiler-0.5.30.jar"
            >
            <Link>lib/procyon-decompiler-0.5.30.jar</Link>
            <CopyToOutputDirectory>Allways</CopyToOutputDirectory>
            <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
            <Visible>true</Visible>
        </None>
        <None Include="$(MSBuildThisFileDirectory)/../lib/cfr_0_132.jar">
            <Link>lib/cfr_0_132.jar</Link>
            <CopyToOutputDirectory>Allways</CopyToOutputDirectory>
            <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
            <Visible>true</Visible>
        </None>
        <None Include="$(MSBuildThisFileDirectory)/../lib/Bytecode-Viewer-2.9.11.jar">
            <CopyToOutputDirectory>Allways</CopyToOutputDirectory>
            <Visible>true</Visible>
        </None>
        <Folder Include="build/$(BindingsHelperFolderDecompilerOutput)/" />
    </ItemGroup>
    <ItemGroup>
        <!--
        MCWs C# code is emitted to folowing folder:
        $(IntermediateOutputPath = "obj/$(Configuration)/generated/src/"
        $(IntermediateOutputPath = "obj/Debug/generated/src/"
        $(IntermediateOutputPath = "obj/Release/generated/src/"
        -->
        <BindingDecompilerBinaries Include="$(MSBuildThisFileDirectory)/../lib/*"></BindingDecompilerBinaries>  
    </ItemGroup> 

    <!--
    AvailableItemName
        EmbeddedJar
        EmbeddedNativeLibrary
        EmbeddedReferenceJar
        InputJar
        JavaDocIndex
        JavaDocJar
        JavaSourceJar
        LibraryProjectProperties
        LibraryProjectZip
        ReferenceJar
        TransformFile
    -->
    <Target 
        Name="MergeArtifactsToDecompile"
        BeforeTargets="CoreCompile"
        >
        <ItemGroup>
            <ArtifactJarsToDecompile Include="@(EmbeddedJar);@(InputJar);@(ReferenceJar)" />
        </ItemGroup>
        <Message Text="EmbeddedJar" />
        <Message Text="    %(EmbeddedJar.Identity)" />
        <Message Text="EmbeddedJar" />
        <Message Text="    %(InputJar.Identity)" />
        <Message Text="EmbeddedJar" />
        <Message Text="    %(ReferenceJar.Identity)" />
        <Message Text="ArtifactJarsToDecompile" />
        <Message Text="    %(ArtifactJarsToDecompile.Identity)" />
        <Message Text="ArtifactJarsToDecompile.Identity" />
        <Message Text="    %(ArtifactJarsToDecompile.Identity)" />
        <Message Text="ArtifactJarsToDecompile.FullPath" />
        <Message Text="    %(ArtifactJarsToDecompile.FullPath)" />
        
        <Message Text="BindingDecompilerBinaries.FullPath" />
        <Message Text="    %(BindingDecompilerBinaries.FullPath)" />
    </Target>
    
    <!--
    Decompiling with JavaP
    https://github.com/moljac/HolisticWare.WebSite.CompositeC1.Content.MarkDown/blob/master/xamarin/products/xamarin-platform/traditional-standard/xamarin-android/advanced/bindings/java-bindings/analysis-java-binaries-jars-decompiling.md
    
    export JAR_ARTIFACT=../../../../externals/android/grpc-stub-1.14.0.jar
    javap \
        -classpath $JAR_ARTIFACT \
            $(jar -tf $JAR_ARTIFACT | grep "class$" | sed s/\.class$//) \
            >> $JAR_ARTIFACT.class.java.txt

    javap -classpath ../../../../externals/android/grpc-stub-1.14.0.jar \
            \$\(jar -tf ../../../../externals/android/grpc-stub-1.14.0.jar | grep &quot;class$&quot; | sed s/\.class$//\) \
            >> grpc-stub-1.14.0.jar.class.java.txt
            
    TURNED OFF - NEED INFO ON CHARACTER ENCODING
    <Target
        Name="DecompileJavaJavaP" 
        BeforeTargets="CoreCompile"
        >
        <Exec 
            Command="javap -classpath @(EmbeddedJar) $(jar -tf @(EmbeddedJar) | grep &quot;class$&quot; | sed &quot;s/\.class$//&quot; ) >> javap.dump.class"
            /> 
    </Target>
    -->

    <!--
    Decompiling with Procyon
    https://bitbucket.org/mstrobel/procyon/wiki/Java%20Decompiler

    export JAR_ARTIFACT=../../../../externals/android/grpc-stub-1.14.0.jar
    java \
        -jar ./procyon-decompiler-0.5.30.jar \
        -jar $JAR_ARTIFACT/grpc-stub-1.14.0.jar \
        dump/
    -->
    <Target 
        Name="DecompileJavaProcyonClassic" 
        Condition=" '$(Sdk)'!='Microsoft.NET.Sdk' " 
        BeforeTargets="CoreCompile"
        >
        <Exec 
            Command="java -jar $(BindingsHelperFolderLibsInNuget)/procyon-decompiler-0.5.30.jar -jar %(ArtifactJarsToDecompile.FullPath) > $(BindingsHelperFolderDecompilerOutput)\%(ArtifactJarsToDecompile.Filename).procyon.dump.cli.classes"
            /> 
    </Target>
    <Target
        Name="DecompileJavaProcyonSdk" 
        Condition=" '$(Sdk)'=='Microsoft.NET.Sdk' " 
        BeforeTargets="CoreCompile"
        >
        <Exec Command="pwd" ></Exec>
        
        <Message Text="mc++ SDK style project - Exec fails! Why? No idea..." Importance="high"></Message>
        <!--
        -->
        
        <Exec 
            Command="java -jar $(BindingsHelperFolderLibsInNuget)/procyon-decompiler-0.5.30.jar -jar %(ArtifactJarsToDecompile.FullPath) > $(BindingsHelperFolderDecompilerOutput)\%(ArtifactJarsToDecompile.Filename).procyon.dump.cli.classes"
            /> 
    </Target>


    <!--
    Decompiling with CFR
    http://www.benf.org/other/cfr/

    export JAR_ARTIFACT=../../../../externals/android/grpc-stub-1.14.0.jar
    java \
        -jar ./cfr_0_132.jar \
        -jar $JAR_ARTIFACT
    -->
    <Target 
        Name="DecompileJavaCFRClassic" 
        Condition=" '$(Sdk)'!='Microsoft.NET.Sdk' " 
        BeforeTargets="CoreCompile"
        >
        <Exec 
            Command="java -jar $(BindingsHelperFolderLibsInNuget)/cfr_0_132.jar -jar %(ArtifactJarsToDecompile.FullPath) > $(BindingsHelperFolderDecompilerOutput)\%(ArtifactJarsToDecompile.Filename).cfr.dump.cli.classes"
            /> 
    </Target>
    <Target
        Name="DecompileJavaCFRSdk" 
        Condition=" '$(Sdk)'=='Microsoft.NET.Sdk' " 
        BeforeTargets="CoreCompile"
        >
        <!--
            EXEC: Error: Unable to access jarfile lib/cfr_0_132.jar (Sample.XamarinAndroid.Bindings.SDK)
            0.0.3/build/HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.targets(9,9): 
            Error MSB3073: 
            The command 
                "\
                java \
                -jar lib/cfr_0_132.jar \
                -jar /Projects/hw-tools/HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers/externals/android/grpc-stub-1.14.0.jar \
                > \
                holisticware-generated/decompilers/cfr.1.grpc-stub-1.14.0.dump.class
                " 
            exited with code 1. 
        -->        
        <Exec 
            Command="java -jar $(BindingsHelperFolderLibsInNuget)/cfr_0_132.jar -jar %(ArtifactJarsToDecompile.FullPath) > $(BindingsHelperFolderDecompilerOutput)\%(ArtifactJarsToDecompile.Filename).cfr.dump.cli.classes"
            /> 
    </Target>

    
    <!--
    java -jar Bytecode-Viewer-2.9.11.jar -help
    https://the.bytecode.club - Created by @Konloch - Bytecode Viewer 2.9.11, FatJar: true
    -help                         Displays the help menu
    -list                         Displays the available decompilers
    -decompiler <decompiler>      Selects the decompiler, procyon by default
    -i <input file>               Selects the input file
    -o <output file>              Selects the output file
    -t <target classname>         Must either be the fully qualified classname or "all" to decompile all as zip
    -nowait                       Doesn't wait for the user to read the CLI messages
    -->
    
  <PropertyGroup>
    <TaskFolder>netstandard2.0</TaskFolder>
    <!--
    <TaskFolder Condition=" '$(MSBuildRuntimeType)' != 'Core' ">net46</TaskFolder>
    -->
    <TaskAssembly>$(MSBuildThisFileDirectory)..\tools\$(TaskFolder)\HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.dll</TaskAssembly>
  </PropertyGroup>

  <UsingTask 
        TaskName="HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.DecompilerTaskForJavaBinaries" 
        AssemblyFile="$(TaskAssembly)" 
        />
    <Target
        Name="Run_DecompilerTaskForJavaBinaries" 
        BeforeTargets="CoreCompile"
        >
        <Message Text="mc++ Target=DecompilerTaskForJavaBinaries"></Message>
        <HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.DecompilerTaskForJavaBinaries
            Executable="javap"
            JarBinaryDecompiler="javap"
            JarBinaryAndroidArtifact="%(ArtifactJarsToDecompile.FullPath)"
            Options=" "
            >            
        </HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.DecompilerTaskForJavaBinaries>
        <HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.DecompilerTaskForJavaBinaries
            Executable="java"
            JarBinaryDecompiler="$(BindingsHelperFolderLibsInNuget)/procyon-decompiler-0.5.30.jar"
            JarBinaryAndroidArtifact="%(ArtifactJarsToDecompile.FullPath)"
            Options=" "
            >            
        </HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.DecompilerTaskForJavaBinaries>
        <HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.DecompilerTaskForJavaBinaries
            Executable="java"
            JarBinaryDecompiler="$(BindingsHelperFolderLibsInNuget)/cfr_0_132.jar"
            JarBinaryAndroidArtifact="%(ArtifactJarsToDecompile.FullPath)"
            Options=" "
            >            
        </HolisticWare.Xamarin.Tools.Bindings.XamarinAndroid.Decompilers.DecompilerTaskForJavaBinaries>
    </Target>

</Project>
